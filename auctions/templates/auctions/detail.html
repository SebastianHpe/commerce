{% extends "auctions/layout.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block body %}
<div class="card" style="max-width: 1200px; padding-left: 0.25rem;">
    <!-- Title and Watchlist -->
    <div class="d-flex justify-content-between align-items-start">
        <h1 class="mb-1">
            {{ listing.title }}
            {% if listing.status == 1 %}
                (Deactivated)
                {% if listing.winner == request.user %}
                    - You won this auction!
                {% endif %}
            {% endif %}
        </h1>

        <form action="{% url 'watchlist' %}" method="post" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="listing_id" value="{{ listing.id }}">
            {% if user in listing.watchers.all %}
                <button type="submit" class="btn btn-secondary ml-2 mt-2 mr-2">Remove from Watchlist</button>
            {% else %}
                <button type="submit" class="btn btn-secondary ml-2 mt-2 mr-2">Add to Watchlist</button>
            {% endif %}
        </form>
    </div>

    <!-- Badges -->
    <div class="d-flex mb-1 mt-1 ml-1" style="height: 30px; align-items: center; gap: 0.5rem;">
        <div class="d-flex mb-2 ml-1" style="gap: 0.5rem;">
            {% if listing.status == 1 %}
                <span class="badge bg-success text-light px-2" style="width: 80px;">Sold</span>
            {% endif %}
            {% if request.user in listing.watchers.all %}
                <span class="badge bg-secondary text-light px-2" style="width: 80px;">Watchlist</span>
            {% endif %}
        </div>
    </div>

    <!-- Image -->
    <img src="{% if listing.image %}{{ listing.image.url }}{% else %}{% static 'auctions/default.png' %}{% endif %}"
        class="img-fluid mb-2"
        style="max-height:500px; object-fit:scale-down;"
        alt="{{ listing.title|default:'No image' }}">

    <!-- Description -->
    <p class="card-text">{{ listing.description|truncatewords:80 }}</p>

    <!-- Bids -->
    {% if listing.status == 0 %}
    <div class="d-flex align-items-center mb-3 gap-3 flex-wrap">
        <!-- Current Price -->
        <p class="mb-3 fw-bold mr-2" style="font-size: 2rem;">
            ${{ listing.highest_bid.price|default:listing.starting_bid }}
        </p>

        <!-- Bid Form -->
        <form method="POST" class="d-flex align-items-center gap-2 mb-0">
            {% csrf_token %}
            {{ bid_form.price|as_crispy_field }}
            <button type="submit" name="submit_bid" class="btn btn-primary ml-2 mb-3">Place Bid</button>
        </form>
    </div>
    {% endif %}

    <!-- Details -->
    <h2>Details</h2>
    <ul>
        <li>Listed by {{ listing.author }}</li>
        <li>Category: {{ listing.category }}</li>
        <li>Posted: {{ listing.date_posted|date:"M d, Y" }}</li>
    </ul>

    <!-- Close / Delete Buttons -->
    {% if listing.author == request.user %}
    <div class="d-flex gap-2 mb-2">
        {% if listing.status == 0 %}
        <!-- Close Listing Button -->
        <button type="button" class="btn btn-primary cls-dlt-btn mr-1" 
                data-bs-toggle="modal" data-bs-target="#closeModal">
            Close Listing
        </button>
        {% endif %}

        <!-- Delete Listing Button -->
        <button type="button" class="btn btn-danger cls-dlt-btn mr-1" 
                data-bs-toggle="modal" data-bs-target="#deleteModal">
            Delete Listing
        </button>
    </div>
    {% endif %}

    {% for comment in comments %}
    <div class="card mb-2 shadow-sm {% if comment.author == request.user %}bg-light{% endif %}" style="width: 1000px;">
        <div class="card-body p-2">
            <div class="d-flex justify-content-between align-items-center mb-1">
            <!-- Author -->
            <h6 class="card-subtitle mb-0 fw-bold">{{ comment.author }}</h6>
            <!-- Date -->
            <small class="text-muted">{{ comment.date_posted|date:"M d, Y H:i" }}</small>
            </div>
            <!-- Content -->
            <p class="card-text mb-0">{{ comment.content }}</p>
        </div>
    </div>
    {% endfor %}

    <form method="POST" class="d-flex flex-column gap-2 mb-3" style="width: 1000px;">
        {% csrf_token %}
        {{ comment_form|crispy }}
        <button type="submit" name="submit_comment" class="btn btn-secondary mb-1">Comment</button>
    </form>

    <!-- Close Modal -->
    <div class="modal fade" id="closeModal" tabindex="-1" aria-labelledby="closeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="closeModalLabel">Confirm Closing</h5>
                </div>
                <div class="modal-body">
                    Are you sure you want to close "{{ listing.title }}"?
                    {% if listing.highest_bid %}
                        The current highest bidder is {{ listing.highest_bidder }}.
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form action="{% url 'close_listing' listing.id %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary cls-dlt-btn">Yes, close</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete "{{ listing.title }}"?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form action="{% url 'delete_listing' listing.id %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger cls-dlt-btn">Yes, delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
